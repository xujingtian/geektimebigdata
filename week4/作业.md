# 1、查看数据

ls /data/hive    查看后一共三份数据：movies.dat  ratings.dat  users.dat

> **movies.dat**  (共 3000+ 条数据)
>
> - 字段为：MovieID, MovieName, MovieType
> - 字段中文解释：电影 ID，电影名，电影类型
>
> **ratings.dat**(100 万 + 条数据)
>
> - 字段为：UserID, MovieID, Rate, Times
> - 字段中文解释：用户 ID，电影 ID，评分，评分时间
>
> **users.dat**(6000+ 条数据)
>
> - 字段为：UserID, Sex, Age, Occupation, Zipcode
>
> - 字段中文解释：用户 id，性别，年龄，职业，邮编
>
>   

# 2、复制数据

> **hdfs分区创建自己的数据目录**
>
> hadoop fs -mkdir -p /user/xujingtian/movies
> hadoop fs -mkdir -p /user/xujingtian/ratings
> hadoop fs -mkdir -p /user/xujingtian/users
>
> **复制共享区的hdfs文件到自己的数据目录**
>
> hadoop fs -cp /data/hive/movies/*  /user/xujingtian/movies
> hadoop fs -cp /data/hive/ratings/*  /user/xujingtian/ratings
> hadoop fs -cp /data/hive/users/*  /user/xujingtian/users
> hadoop fs -ls /user/xujingtian/movies
> hadoop fs -ls /user/xujingtian/ratings
> hadoop fs -ls /user/xujingtian/users

# 3、创建数据库及表

>  **访问**hive
> beeline -u jdbc:hive2://localhost:10000
>
>  **检查数据库**
> show databases;
>
>  **创建数据库**
> create database if not exists xujingtian comment "xujingtian test";
>
>  **创建表t_movie**
> create external table if not exists xujingtian.t_movie(
> movie_id bigint comment "ID",
> movie_name string comment "name",
> movie_type string comment "type"
> )
> comment "table movie"
> ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe' 
> WITH SERDEPROPERTIES ("field.delim"="::")
> stored as textfile;
>
>  **创建表t_rating**
> create external table if not exists xujingtian.t_rating(
> user_id bigint comment "user ID",
> movie_id bigint comment "movie ID",
> rate tinyint comment "ID",
> times bigint comment "rate times"
> )
> comment "table rating"
> ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe' 
> WITH SERDEPROPERTIES ("field.delim"="::")
> stored as textfile;
>
>  **创建表t_user**
> create table if not exists xujingtian.t_user(
> user_id bigint comment "user ID",
> sex string comment "sex",
> age int comment "age",
> occupation int comment "occupation",
> zipcode bigint comment "zipcode"
> )
> comment "table user"
> ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe' 
> WITH SERDEPROPERTIES ("field.delim"="::")
> stored as textfile;

# 4、导入数据

>  **装入数据**
> load data inpath '/user/xujingtian/movies/movies.dat' OVERWRITE into table xujingtian.t_movie;
> load data inpath '/user/xujingtian/ratings/ratings.dat' OVERWRITE into table xujingtian.t_rating;
> load data inpath '/user/xujingtian/users/users.dat' OVERWRITE into table xujingtian.t_user;
>
>  **显示已创建表**
> use xujingtian;
> show tables;
>
>  **查询表内记录**
> select * from t_user;
>
> ![image-20220402234823345](D:\99.dean_pc\08.geektime\13.大数据\03.code\week4\作业.assets\image-20220402234823345.png)
>
> select count(1) from t_rating;
>
> ![image-20220402234806021](D:\99.dean_pc\08.geektime\13.大数据\03.code\week4\作业.assets\image-20220402234806021.png)
>
> select count(1) from t_movie;
>
> ![image-20220402234915021](D:\99.dean_pc\08.geektime\13.大数据\03.code\week4\作业.assets\image-20220402234915021.png)
>
>  **显示表结构**
> desc t_user;
>
>  **显示表创建语句**
> show create table t_user;
>
> 

# 5、题目一（简单）

展示电影 ID 为 2116 这部电影各年龄段的平均影评分。

> select u.age as age,avg(r.rate) as avgrate
> from t_rating r join t_user u on r.user_id=u.user_id
> where r.movie_id=2116
> group by u.age;
>
> ![image-20220402235522145](D:\99.dean_pc\08.geektime\13.大数据\03.code\week4\作业.assets\image-20220402235522145.png)

# 6、题目二（中等）

找出男性评分最高且评分次数超过 50 次的 10 部电影，展示电影名，平均影评分和评分次数。

> select "M" as sex, m.movie_name as name, avg(r.rate) as avgrate, count(m.movie_name) as total  
> from t_rating r 
> join t_user u on r.user_id=u.user_id 
> join t_movie m on r.movie_id=m.movie_id 
> where u.sex="M" 
> group by m.movie_name 
> having total >= 50
> order by avgrate desc 
> limit 10;
>
> ![image-20220402235817698](D:\99.dean_pc\08.geektime\13.大数据\03.code\week4\作业.assets\image-20220402235817698.png)





# 7、题目三（选做）

找出影评次数最多的女士所给出最高分的 10 部电影的平均影评分，展示电影名和平均影评分（可使用多行 SQL）。

> 1） 找出评论数最多的女士ID,得到结果为：1150
>
> select r.user_id, count(r.user_id) as total 
> from T_rating r join T_user u on r.user_id = u.user_id 
> where u.sex="F" 
> group by r.user_id 
> order by total desc 
> limit 1;
>
> ![image-20220403000234832](D:\99.dean_pc\08.geektime\13.大数据\03.code\week4\作业.assets\image-20220403000234832.png)
>
> 2） 根据ID 10015 查找其评分最高的10部电影
>
> create table tmp1 as 
> select r.movie_id as movie_id, r.rate as rate  
> from t_rating r 
> where r.user_id=1150 
> order by rate desc 
> limit 10;
>
> ![image-20220403000736500](D:\99.dean_pc\08.geektime\13.大数据\03.code\week4\作业.assets\image-20220403000736500.png)
>
> select * from tmp1;
>
> ![image-20220403000812809](D:\99.dean_pc\08.geektime\13.大数据\03.code\week4\作业.assets\image-20220403000812809.png)
>
> 3）根据move_id得出的10部电影的平均电影评分
>
> select r.movie_id as movie_id, m.movie_name as movie_name, avg(r.rate) as avgrate 
> from tmp1 tm 
> join t_rating r on tm.movie_id=r.movie_id 
> join t_movie m on r.movie_id=m.movie_id 
> group by r.movie_id,m.movie_name;
>
> ![image-20220403001356712](D:\99.dean_pc\08.geektime\13.大数据\03.code\week4\作业.assets\image-20220403001356712.png)